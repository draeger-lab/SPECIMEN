<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>specimen.hqtb.core.refinement.smoothing &mdash; SPECIMEN 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=559046d4" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=ef5873f9" />

  
    <link rel="shortcut icon" href="../../../../../_static/LogoSPECIMEN.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../../_static/copybutton.js?v=7859de39"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html">
            
              <img src="../../../../../_static/LogoSPECIMEN.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../overview-pipes.html">Overview of the Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../specimen.html">Contents of SPECIMEN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../help.html">Help &amp; FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dev-notes.html">Notes for Developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">SPECIMEN</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">specimen.hqtb.core.refinement.smoothing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for specimen.hqtb.core.refinement.smoothing</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Perform part 4 of the refinement: smoothing.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Carolin Brune&#39;</span>

<span class="c1">################################################################################</span>
<span class="c1"># requirements</span>
<span class="c1">################################################################################</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">BOFdat</span> <span class="kn">import</span> <span class="n">step1</span>
<span class="kn">from</span> <span class="nn">BOFdat</span> <span class="kn">import</span> <span class="n">step2</span>
<span class="kn">from</span> <span class="nn">BOFdat.util</span> <span class="kn">import</span> <span class="n">update</span>
<span class="kn">from</span> <span class="nn">BOFdat.util.update</span> <span class="kn">import</span> <span class="n">determine_coefficients</span>
<span class="kn">from</span> <span class="nn">MCC</span> <span class="kn">import</span> <span class="n">MassChargeCuration</span>

<span class="kn">import</span> <span class="nn">cobra</span>
<span class="kn">from</span> <span class="nn">cobra</span> <span class="kn">import</span> <span class="n">Reaction</span>

<span class="kn">from</span> <span class="nn">refinegems.curation.biomass</span> <span class="kn">import</span> <span class="n">test_biomass_presence</span><span class="p">,</span> <span class="n">check_normalise_biomass</span>
<span class="kn">from</span> <span class="nn">refinegems.analysis.investigate</span> <span class="kn">import</span> <span class="n">run_memote</span>
<span class="kn">from</span> <span class="nn">refinegems.classes</span> <span class="kn">import</span> <span class="n">egcs</span>

<span class="c1"># further required programs:</span>
<span class="c1">#        - BOFdat</span>
<span class="c1">#        - MassChargeCuration</span>

<span class="c1"># note:</span>
<span class="c1">#    for BOFdat to run correctly, you need to change &#39;solution.f&#39; to &#39;solution.objective_value&#39;</span>
<span class="c1">#    in the coenzymes_and_ions.py file of BOFdat</span>

<span class="c1">################################################################################</span>
<span class="c1"># variables</span>
<span class="c1">################################################################################</span>

<span class="c1">################################################################################</span>
<span class="c1"># functions</span>
<span class="c1">################################################################################</span>

<div class="viewcode-block" id="perform_mcc">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.smoothing.perform_mcc">[docs]</a>
<span class="k">def</span> <span class="nf">perform_mcc</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">apply</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the MassChargeCuration toll on the model and optionally directly apply </span>
<span class="sd">    the solution.</span>

<span class="sd">    Args:</span>
<span class="sd">        - model (cobra.Model): </span>
<span class="sd">            The model to use the tool on.</span>
<span class="sd">        - dir (str): </span>
<span class="sd">            Path of the directory to save MCC output in.</span>
<span class="sd">        - apply (bool, optional): </span>
<span class="sd">            If True, model is directly updated with the results. </span>
<span class="sd">            Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        cobra.Model: </span>
<span class="sd">            The model (updated or not)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make temporary directory to save files for MCC in</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp</span><span class="p">:</span>

        <span class="c1"># use MCC</span>
        <span class="k">if</span> <span class="n">apply</span><span class="p">:</span>
            <span class="c1"># update model</span>
            <span class="n">balancer</span> <span class="o">=</span> <span class="n">MassChargeCuration</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">update_ids</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="n">temp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># do not change original model</span>
            <span class="n">model_copy</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">balancer</span> <span class="o">=</span> <span class="n">MassChargeCuration</span><span class="p">(</span><span class="n">model_copy</span><span class="p">,</span> <span class="n">update_ids</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="n">temp</span><span class="p">)</span>

    <span class="c1"># save reports</span>
    <span class="n">balancer</span><span class="o">.</span><span class="n">generate_reaction_report</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s1">&#39;_mcc_reactions&#39;</span><span class="p">))</span>
    <span class="n">balancer</span><span class="o">.</span><span class="n">generate_metabolite_report</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s1">&#39;_mcc_metabolites&#39;</span><span class="p">))</span>
    <span class="n">balancer</span><span class="o">.</span><span class="n">generate_visual_report</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="o">+</span><span class="s1">&#39;_mcc_visual&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">model</span></div>



<div class="viewcode-block" id="adjust_BOF">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.smoothing.adjust_BOF">[docs]</a>
<span class="k">def</span> <span class="nf">adjust_BOF</span><span class="p">(</span><span class="n">genome</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">model_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span><span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">dna_weight_fraction</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">weight_frac</span><span class="p">:</span><span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adjust the model&#39;s BOF using BOFdat. Currently implemented are step 1</span>
<span class="sd">    DNA coefficients and step 2.</span>

<span class="sd">    Args:</span>
<span class="sd">        - genome (str): </span>
<span class="sd">            Path to the genome (e.g. .fna) FASTA file.</span>
<span class="sd">        - model_file (str): </span>
<span class="sd">            Path to the sbml (.xml) file of the model.</span>
<span class="sd">        - model (cobra.Model): </span>
<span class="sd">            The genome-scale metabolic model (from the string above), loaded with COBRApy.</span>
<span class="sd">        - dna_weight_fraction (float): </span>
<span class="sd">            DNA weight fraction for BOF step 1.</span>
<span class="sd">        - weight_frac (float): </span>
<span class="sd">            Weight fraction for the second step of BOFdat (enzymes and ions)</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: </span>
<span class="sd">            The updated BOF reaction as a reaction string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    

    <span class="c1"># BOFdat step 1:</span>
    <span class="c1"># --------------</span>
    <span class="c1"># dna coefficients</span>
    <span class="n">dna_coefficients</span> <span class="o">=</span> <span class="n">step1</span><span class="o">.</span><span class="n">generate_dna_coefficients</span><span class="p">(</span><span class="n">genome</span><span class="p">,</span><span class="n">model_file</span><span class="p">,</span><span class="n">DNA_WEIGHT_FRACTION</span><span class="o">=</span><span class="n">dna_weight_fraction</span><span class="p">)</span>
    <span class="n">bd_step1</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">dna_coefficients</span><span class="p">:</span>
        <span class="n">bd_step1</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dna_coefficients</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

    <span class="c1"># ...........................</span>
    <span class="c1"># @TODO</span>
    <span class="c1">#    if time permits or needed, options for more coefficients can be added</span>
    <span class="c1"># ...........................</span>

    <span class="c1"># BOFdat step 2:</span>
    <span class="c1"># --------------</span>
    <span class="c1"># find inorganic ions</span>
    <span class="n">selected_metabolites</span> <span class="o">=</span> <span class="n">step2</span><span class="o">.</span><span class="n">find_coenzymes_and_ions</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
    <span class="c1"># determine coefficients</span>
    <span class="n">bd_step2</span> <span class="o">=</span> <span class="n">determine_coefficients</span><span class="p">(</span><span class="n">selected_metabolites</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">weight_frac</span><span class="p">)</span>
    <span class="n">bd_step2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bd_step1</span><span class="p">)</span>

    <span class="c1"># update BOF</span>
    <span class="c1"># ----------</span>
    <span class="c1">#  retrieve previously used BOF</span>
    <span class="n">growth_func_list</span> <span class="o">=</span> <span class="n">test_biomass_presence</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">growth_func_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
        <span class="n">objective_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">growth_func_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">growth_func_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mes</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Multiple BOFs found. Using </span><span class="si">{</span><span class="n">growth_func_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> for BOF adjustment.&#39;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">mes</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
        <span class="n">objective_list</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">growth_func_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="c1"># else not needed, as if there is no BOF, a new one will be created</span>

    <span class="c1"># ...............................................................</span>
    <span class="n">objective_reactant</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">objective_product</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">product</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># get reactants, product and factors from equation</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">objective_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">product</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">product</span><span class="p">:</span>
                <span class="n">objective_product</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">objective_reactant</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor</span>

    <span class="c1"># update BOF information with data from BOFdat</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">bd_step2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bd_step2</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">objective_reactant</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd_step2</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">objective_product</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">bd_step2</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

    <span class="c1"># create new objective function</span>
    <span class="n">new_objective</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">objective_reactant</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">new_objective</span> <span class="o">+=</span> <span class="s1">&#39; --&gt; &#39;</span>
    <span class="n">new_objective</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">objective_product</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">new_objective</span></div>



<div class="viewcode-block" id="run">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.smoothing.run">[docs]</a>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">genome</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">model</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">mcc</span><span class="o">=</span><span class="s1">&#39;skip&#39;</span><span class="p">,</span>
        <span class="n">egc_solver</span><span class="p">:</span><span class="kc">None</span><span class="o">|</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;greedy&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;BiGG&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;BiGG&#39;</span><span class="p">,</span>
        <span class="n">dna_weight_frac</span><span class="o">=</span><span class="mf">0.023</span><span class="p">,</span><span class="n">ion_weight_frac</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> 
        <span class="n">memote</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform the fourth step of the refinement, smoothing, on a model.</span>

<span class="sd">    The fourth step of the refinment, smoothing, includes:</span>

<span class="sd">    - Mass-Charge curation</span>
<span class="sd">    - checking energy generating cycles</span>
<span class="sd">    - adjusting Biomass objective function parameters based on genome</span>

<span class="sd">    Args:</span>
<span class="sd">        - genome (str): </span>
<span class="sd">            Path to the genome FASTA (e.g. .fna) file of your genome.</span>
<span class="sd">        - model (str): </span>
<span class="sd">            Path to the model. Should be sbml-format.</span>
<span class="sd">        - dir (str): </span>
<span class="sd">            Path of the output directory.</span>
<span class="sd">        - mcc (str, optional): </span>
<span class="sd">            Option for the Mass-Charge curation.</span>
<span class="sd">            Can be &#39;skip&#39;, &#39;apply&#39; (directly use MCC on model) or &#39;extra&#39; (only generate information). </span>
<span class="sd">            Defaults to &#39;skip&#39;.</span>
<span class="sd">        - egc_solver (None | Literal[&#39;greedy&#39;], optional): </span>
<span class="sd">            If given, uses the option to solve EGCs.</span>
<span class="sd">            Current options include greedy (Greedy Solver).</span>
<span class="sd">            Defaults to &#39;greedy&#39;.</span>
<span class="sd">        - namespace (Literal[&#39;BiGG&#39;], optional): </span>
<span class="sd">            Namespace to use for the model.</span>
<span class="sd">            Defaults to &#39;BiGG&#39;.</span>
<span class="sd">        - dna_weight_frac (float, optional): </span>
<span class="sd">            DNA weight fraction to use for BOFdat.</span>
<span class="sd">            Default is 0.023 for Klebsiella pneumoniae based on Liao et al.</span>
<span class="sd">        - ion_weight_frac (float, optional): </span>
<span class="sd">            Ion weight fraction to use for BOFdat.</span>
<span class="sd">            Defaults to 0.05.</span>
<span class="sd">        - memote (bool, optional): </span>
<span class="sd">            Option to run memote after the refinement.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">refinement step 4: smoothing</span><span class="se">\n</span><span class="s1">################################################################################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># -----------------------</span>
    <span class="c1"># create output directory</span>
    <span class="c1"># -----------------------</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;step4-smoothing&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;Creating new directory </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;step4-smoothing&quot;</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given directory already has required structure.&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;manual_curation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;Creating new directory </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;manual_curation&quot;</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given directory already has required structure.&#39;</span><span class="p">)</span>

    <span class="c1"># ---------</span>
    <span class="c1"># load data</span>
    <span class="c1"># ---------</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">cobra</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_sbml_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># ---------------</span>
    <span class="c1"># mass and charge</span>
    <span class="c1"># ---------------</span>

    <span class="k">if</span> <span class="n">mcc</span> <span class="o">==</span> <span class="s1">&#39;apply&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># ----------------------------------</span><span class="se">\n</span><span class="s1"># mass and charge curation (applied)</span><span class="se">\n</span><span class="s1"># ----------------------------------&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">perform_mcc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;step4-smoothing&quot;</span><span class="p">))</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mcc</span> <span class="o">==</span> <span class="s1">&#39;extra&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># --------------------------------</span><span class="se">\n</span><span class="s1"># mass and charge curation (extra)</span><span class="se">\n</span><span class="s1"># --------------------------------&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">perform_mcc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;manual_curation&quot;</span><span class="p">),</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mcc</span> <span class="o">==</span> <span class="s1">&#39;skip&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># ------------------------</span><span class="se">\n</span><span class="s1"># mass and charge curation</span><span class="se">\n</span><span class="s1"># ------------------------</span><span class="se">\n\t</span><span class="s1">skipped&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;Unknown option </span><span class="si">{</span><span class="n">mcc</span><span class="si">}</span><span class="s1"> for Mass and Charge Curation. Usage of MCC will be skipped.&#39;</span><span class="p">)</span>

    <span class="c1"># ----------------------------------</span>
    <span class="c1"># check for energy generating cycles</span>
    <span class="c1"># ----------------------------------</span>
    <span class="c1"># check if some exist</span>
    <span class="c1"># not implemented: solve them, as it is heavily dependant on biology (hard to perform automated)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># ---------------------------------------------</span><span class="se">\n</span><span class="s1"># # check for energy generating cycles</span><span class="se">\n</span><span class="s1"># ---------------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">match</span> <span class="n">egc_solver</span><span class="p">:</span>
        <span class="c1"># greedy solver</span>
        <span class="k">case</span> <span class="s1">&#39;greedy&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GreedyEGCSolver:&#39;</span><span class="p">)</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">egcs</span><span class="o">.</span><span class="n">GreedyEGCSolver</span><span class="p">()</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve_egcs</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span> <span class="c1"># @NOTE automatically uses c,p as compartments - maybe change later</span>
            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># no solver = EGCs will only be reported</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">egcs</span><span class="o">.</span><span class="n">EGCSolver</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Found EGCs:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">solver</span><span class="o">.</span><span class="n">find_egcs</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># biomass objective function</span>
    <span class="c1"># --------------------------</span>
    <span class="c1"># adjust the BOF to the current genome</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># ----------</span><span class="se">\n</span><span class="s1"># adjust BOF</span><span class="se">\n</span><span class="s1"># ----------&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.xml&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_model</span><span class="p">:</span>
        <span class="c1"># generate an up-to-date model xml-file</span>
        <span class="n">cobra</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_sbml_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">temp_model</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># update BOF</span>
        <span class="n">pos_bofs</span> <span class="o">=</span> <span class="n">test_biomass_presence</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_bofs</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">pos_bofs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reaction</span> <span class="o">=</span> <span class="n">adjust_BOF</span><span class="p">(</span><span class="n">genome</span><span class="p">,</span> <span class="n">temp_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dna_weight_frac</span><span class="p">,</span> <span class="n">ion_weight_frac</span><span class="p">)</span>
            <span class="c1"># optimise BOF(s)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">check_normalise_biomass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># create new BOF</span>
            <span class="n">bof_reac</span> <span class="o">=</span> <span class="n">Reaction</span><span class="p">(</span><span class="s1">&#39;Biomass_BOFdat&#39;</span><span class="p">)</span>
            <span class="n">bof_reac</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Biomass objective function created by BOFdat&#39;</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add_reactions</span><span class="p">([</span><span class="n">bof_reac</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">pos_bofs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reaction</span> <span class="o">=</span> <span class="n">adjust_BOF</span><span class="p">(</span><span class="n">genome</span><span class="p">,</span> <span class="n">temp_model</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dna_weight_frac</span><span class="p">,</span> <span class="n">ion_weight_frac</span><span class="p">)</span>
       
            <span class="c1"># optimise BOF(s)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">check_normalise_biomass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>


    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>

    <span class="c1"># ----------------</span>
    <span class="c1"># save final model</span>
    <span class="c1"># ----------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># ----------</span><span class="se">\n</span><span class="s1"># save model</span><span class="se">\n</span><span class="s1"># ----------&#39;</span><span class="p">)</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="sa">F</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_smooth&#39;</span>
    <span class="n">outname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s1">&#39;step4-smoothing&#39;</span><span class="p">,</span><span class="n">model_name</span><span class="o">+</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">saving to: </span><span class="si">{</span><span class="n">outname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">cobra</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_sbml_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">outname</span><span class="p">)</span>

    <span class="c1"># ---------------------------------</span>
    <span class="c1"># assess model quality using memote</span>
    <span class="c1"># ---------------------------------</span>

    <span class="k">if</span> <span class="n">memote</span><span class="p">:</span>
        <span class="n">memote_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s1">&#39;step4-smoothing&#39;</span><span class="p">,</span><span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.html&#39;</span><span class="p">)</span>
        <span class="n">run_memote</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">return_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_res</span><span class="o">=</span><span class="n">memote_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Carolin Brune.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>