<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>specimen.hqtb.core.refinement.cleanup &mdash; SPECIMEN 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=559046d4" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=ef5873f9" />

  
    <link rel="shortcut icon" href="../../../../../_static/LogoSPECIMEN.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../../../_static/copybutton.js?v=7859de39"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html">
            
              <img src="../../../../../_static/LogoSPECIMEN.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../overview-pipes.html">Overview of the Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../specimen.html">Contents of SPECIMEN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../help.html">Help &amp; FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dev-notes.html">Notes for Developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">SPECIMEN</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">specimen.hqtb.core.refinement.cleanup</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for specimen.hqtb.core.refinement.cleanup</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Perform part 3 of the refinement: clean-up.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Carolin Brune&#39;</span>

<span class="c1">################################################################################</span>
<span class="c1"># requirements</span>
<span class="c1">################################################################################</span>

<span class="kn">import</span> <span class="nn">cobra</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span><span class="n">Union</span>

<span class="kn">from</span> <span class="nn">refinegems.utility.io</span> <span class="kn">import</span> <span class="n">load_model</span>
<span class="kn">from</span> <span class="nn">refinegems.classes.medium</span> <span class="kn">import</span> <span class="n">medium_to_model</span><span class="p">,</span> <span class="n">Medium</span>
<span class="kn">from</span> <span class="nn">refinegems.analysis.growth</span> <span class="kn">import</span> <span class="n">read_media_config</span>
<span class="kn">from</span> <span class="nn">refinegems.utility.connections</span> <span class="kn">import</span> <span class="n">run_memote</span>
<span class="kn">from</span> <span class="nn">refinegems.curation.curate</span> <span class="kn">import</span> <span class="n">resolve_duplicates</span><span class="p">,</span> <span class="n">complete_BioMetaCyc</span>

<span class="c1">################################################################################</span>
<span class="c1"># variables</span>
<span class="c1">################################################################################</span>

<span class="c1">################################################################################</span>
<span class="c1"># functions</span>
<span class="c1">################################################################################</span>


<span class="c1"># @ADDED TO refinegems </span>
<span class="c1"># @TODO - use the functions here as well, without skipping the creation label</span>
<span class="c1"># --&gt; how to include the check? </span>
<span class="c1"># - for now, this func will be kept</span>
<div class="viewcode-block" id="check_direction">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.cleanup.check_direction">[docs]</a>
<span class="k">def</span> <span class="nf">check_direction</span><span class="p">(</span><span class="n">model</span><span class="p">:</span><span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span><span class="n">data_file</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the direction of newly created reactions (01-extention) by searching for matching MetaCyc,</span>
<span class="sd">    KEGG and MetaNetX IDs as well as EC number in a downloaded BioCyc (MetaCyc)</span>
<span class="sd">    database table (need to contain at least the following columns:</span>
<span class="sd">    Reactions (MetaCyc ID),EC-Number,KEGG reaction,METANETX,Reaction-Direction.</span>

<span class="sd">    @NOTE: checks only creations that do not contain the notes[&#39;creation&#39;] == &#39;via template&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">        - model (cobra.Model): </span>
<span class="sd">            The GEM containing the reactions to be check for direction.</span>
<span class="sd">        - data_file (str): </span>
<span class="sd">            Path to the MetabCyc (BioCyc) smart table.</span>

<span class="sd">    Returns:</span>
<span class="sd">        cobra.Model: </span>
<span class="sd">            The updated model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># create MetaCyc table</span>
    <span class="c1"># --------------------</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># rewrite the columns into a better comparable/searchable format</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;KEGG reaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;KEGG reaction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;.*&gt;(R\d*)&lt;.*&#39;</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;METANETX&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;METANETX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;.*&gt;(MNXR\d*)&lt;.*&#39;</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;EC-Number&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;EC-Number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;EC-(.*)&#39;</span><span class="p">)</span>

    <span class="c1"># check direction</span>
    <span class="c1"># --------------------</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
            <span class="c1"># entry from template, assumed to be already curated</span>
            <span class="k">if</span> <span class="s1">&#39;creation&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">notes</span> <span class="ow">and</span> <span class="s1">&#39;via template&#39;</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s1">&#39;creation&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="c1"># newly created entry, check direction with BioCyc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># easy case: metacyc is already (corretly) annotated</span>
                <span class="k">if</span> <span class="s1">&#39;metacyc.reaction&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Reactions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;metacyc.reaction&#39;</span><span class="p">]])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Reactions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;metacyc.reaction&#39;</span><span class="p">]][</span><span class="s1">&#39;Reaction-Direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s1">&#39;BioCyc direction check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">F</span><span class="s1">&#39;found </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="c1"># complicated case: no metacyc annotation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># collect matches</span>
                    <span class="k">if</span> <span class="s1">&#39;kegg.reaction&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;kegg.reaction&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;KEGG reaction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;KEGG reaction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;kegg.reaction&#39;</span><span class="p">]][</span><span class="s1">&#39;Reactions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="k">if</span> <span class="s1">&#39;metanetx.reaction&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;metanetx.reaction&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;METANETX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;METANETX&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;metanetx.reaction&#39;</span><span class="p">]][</span><span class="s1">&#39;Reactions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="k">if</span> <span class="s1">&#39;ec-code&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;ec-code&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;EC-Number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">annotations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;EC-Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;ec-code&#39;</span><span class="p">]][</span><span class="s1">&#39;Reactions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                    <span class="c1"># check results</span>
                    <span class="c1"># no matches</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s1">&#39;BioCyc direction check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;not found&#39;</span>

                    <span class="c1"># matches found</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># built intersection</span>
                        <span class="n">intersec</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">annotations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="n">annotations</span><span class="p">)</span>
                        <span class="c1"># case 1: exactly one match remains</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">entry</span> <span class="o">=</span> <span class="n">intersec</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="n">direction</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Reactions&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">entry</span><span class="p">][</span><span class="s1">&#39;Reaction-Direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">annotation</span><span class="p">[</span><span class="s1">&#39;metacyc.reaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s1">&#39;BioCyc direction check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">F</span><span class="s1">&#39;found </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">&#39;</span>

                        <span class="c1"># case 2: multiple matches found -&gt; inconclusive</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s1">&#39;BioCyc direction check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">F</span><span class="s1">&#39;found, but inconclusive&#39;</span>

                <span class="c1"># update direction if possible and needed</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">direction</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;REVERSIBLE&#39;</span> <span class="ow">in</span> <span class="n">direction</span><span class="p">:</span>
                        <span class="c1"># set reaction as reversible by setting default values for upper and lower bounds</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1000.</span>
                    <span class="k">elif</span> <span class="s1">&#39;RIGHT-TO-LEFT&#39;</span> <span class="ow">in</span> <span class="n">direction</span><span class="p">:</span>
                        <span class="c1"># invert the default values for the boundaries</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">lower_bound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1000.</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">upper_bound</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># left to right case is the standart for adding reactions</span>
                        <span class="c1"># = nothing left to do</span>
                        <span class="k">continue</span>
    <span class="k">return</span> <span class="n">model</span></div>



<span class="c1"># gap filling</span>
<span class="c1"># -----------</span>

<div class="viewcode-block" id="single_cobra_gapfill">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.cleanup.single_cobra_gapfill">[docs]</a>
<span class="k">def</span> <span class="nf">single_cobra_gapfill</span><span class="p">(</span><span class="n">model</span><span class="p">:</span><span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> 
                         <span class="n">universal</span><span class="p">:</span><span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">medium</span><span class="p">:</span><span class="n">Medium</span><span class="p">,</span> 
                         <span class="n">namespace</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;BiGG&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;BiGG&#39;</span><span class="p">,</span> 
                         <span class="n">growth_threshold</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attempt gapfilling (with COBRApy) for a given model to allow growth on a given</span>
<span class="sd">    medium.</span>

<span class="sd">    Args:</span>
<span class="sd">        - model (cobra.Model): </span>
<span class="sd">            The model to perform gapfilling on.</span>
<span class="sd">        - universal (cobra.Model):  </span>
<span class="sd">            A model with reactions to be potentially used for the gapfilling.</span>
<span class="sd">        - medium (Medium): </span>
<span class="sd">            A medium the model should grow on.</span>
<span class="sd">        - namespace (Literal[&#39;BiGG&#39;], optional): Namespace to use for the model. </span>
<span class="sd">            Defaults to &#39;BiGG&#39;.</span>
<span class="sd">        - growth_threshold (float, optional):  Minimal rate for the model to be considered growing.</span>
<span class="sd">            Defaults to 0.05.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[list[str],True]: </span>
<span class="sd">            List of reactions to be added to the model to allow growth</span>
<span class="sd">            or True, if the model already grows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># perform the gapfilling</span>
    <span class="n">solution</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">model</span> <span class="k">as</span> <span class="n">model_copy</span><span class="p">:</span>
        <span class="c1"># set medium model should grow on</span>
        <span class="n">medium_to_model</span><span class="p">(</span><span class="n">model_copy</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">double_o2</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
        <span class="c1"># if model does not show growth (depending on threshold), perform gapfilling</span>
        <span class="k">if</span> <span class="n">model_copy</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span><span class="o">.</span><span class="n">objective_value</span> <span class="o">&lt;</span> <span class="n">growth_threshold</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">solution</span> <span class="o">=</span> <span class="n">cobra</span><span class="o">.</span><span class="n">flux_analysis</span><span class="o">.</span><span class="n">gapfill</span><span class="p">(</span><span class="n">model_copy</span><span class="p">,</span> <span class="n">universal</span><span class="p">,</span>
                                                       <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">growth_threshold</span><span class="p">,</span>
                                                       <span class="n">demand_reactions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">cobra</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Infeasible</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;Gapfilling for medium </span><span class="si">{</span><span class="n">medium</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> failed. Manual curation required.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;Model already grows on medium </span><span class="si">{</span><span class="n">medium</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> with objective value of </span><span class="si">{</span><span class="n">model_copy</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span><span class="o">.</span><span class="n">objective_value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">solution</span></div>



<div class="viewcode-block" id="cobra_gapfill_wrapper">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.cleanup.cobra_gapfill_wrapper">[docs]</a>
<span class="k">def</span> <span class="nf">cobra_gapfill_wrapper</span><span class="p">(</span><span class="n">model</span><span class="p">:</span><span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">universal</span><span class="p">:</span><span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> 
                          <span class="n">medium</span><span class="p">:</span><span class="n">Medium</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;BiGG&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;BiGG&#39;</span><span class="p">,</span>
                          <span class="n">growth_threshold</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                          <span class="n">iterations</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for :py:func:`~specimen.core.refinement.cleanup.single_cobra_gapfill`.</span>

<span class="sd">    Either use the full set of reactions in universal model by setting iteration to</span>
<span class="sd">    0 or None or use them in randomized chunks for faster runtime (useful</span>
<span class="sd">    on laptops). Note: when using the second option, be aware that this does not</span>
<span class="sd">    test all reaction combinations exhaustively (heuristic approach!!!).</span>

<span class="sd">    Args:</span>
<span class="sd">        - model (cobra.Model): </span>
<span class="sd">            he model to perform gapfilling on.</span>
<span class="sd">        - universal (cobra.Model): </span>
<span class="sd">            A model with reactions to be potentially used for the gapfilling.</span>
<span class="sd">        - medium (Medium): </span>
<span class="sd">            A medium the model should grow on.</span>
<span class="sd">        - namespace (Literal[&#39;BiGG&#39;], optional): </span>
<span class="sd">            Namespace to use for the model. </span>
<span class="sd">            Options include &#39;BiGG&#39;.</span>
<span class="sd">            Defaults to &#39;BiGG&#39;.</span>
<span class="sd">        - growth_threshold (float, optional): </span>
<span class="sd">            Growth threshold for the gapfilling. </span>
<span class="sd">            Defaults to 0.05.</span>
<span class="sd">        - iterations (int, optional): </span>
<span class="sd">            Number of iterations for the heuristic version of the gapfilling.</span>
<span class="sd">            If 0 or None is given, uses full set of reactions.</span>
<span class="sd">            Defaults to 3. </span>
<span class="sd">        - chunk_size (int, optional): </span>
<span class="sd">            Number of reactions to be used for gapfilling at the same time. </span>
<span class="sd">            If None or 0 is given, use full set, not heuristic.</span>
<span class="sd">            Defaults to 10000.</span>

<span class="sd">    Returns:</span>
<span class="sd">        cobra.Model: </span>
<span class="sd">            The gapfilled model, if a solution was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">solution</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># run a heuristic approach:</span>
    <span class="c1">#     for a given number of iterations, use a subset (chunk_size) of</span>
    <span class="c1">#     reactions for the gapfilling</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iterations</span> <span class="ow">and</span> <span class="n">iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">chunk_size</span> <span class="ow">and</span> <span class="n">chunk_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

        <span class="n">num_reac</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>
        <span class="c1"># for each iteration</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">not_used</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_reac</span><span class="p">)]</span>

            <span class="c1"># divide reactions in random subsets</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_reac</span><span class="o">/</span><span class="n">chunk_size</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_used</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">chunk_size</span><span class="p">:</span>
                    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
                    <span class="n">reac_set</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">not_used</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">not_used</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">not_used</span> <span class="k">if</span> <span class="n">_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reac_set</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reac_set</span> <span class="o">=</span> <span class="n">not_used</span>

                <span class="c1"># get subset of reactions</span>
                <span class="n">subset_reac</span> <span class="o">=</span> <span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s1">&#39;subset_reac&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">reac_set</span><span class="p">:</span>
                    <span class="n">subset_reac</span><span class="o">.</span><span class="n">add_reactions</span><span class="p">([</span><span class="n">universal</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()])</span>

                <span class="c1"># gapfilling</span>
                <span class="n">solution</span> <span class="o">=</span> <span class="n">single_cobra_gapfill</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">subset_reac</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">growth_threshold</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">solution</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span><span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">solution</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">break</span>

    <span class="c1"># use the whole reactions content of the universal model at once</span>
    <span class="c1">#     not advised for Laptops and PCs with small computing power</span>
    <span class="c1">#     may take a long time</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">single_cobra_gapfill</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">universal</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">growth_threshold</span><span class="p">)</span>

    <span class="c1"># if solution is found add new reactions to model</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="n">solution</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">reac</span><span class="o">.</span><span class="n">notes</span><span class="p">[</span><span class="s1">&#39;creation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;via gapfilling&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;Adding </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1"> reactions to model to ensure growth on medium </span><span class="si">{</span><span class="n">medium</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add_reactions</span><span class="p">(</span><span class="n">solution</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">model</span></div>



<div class="viewcode-block" id="multiple_cobra_gapfill">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.cleanup.multiple_cobra_gapfill">[docs]</a>
<span class="k">def</span> <span class="nf">multiple_cobra_gapfill</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">universal</span><span class="p">:</span><span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> 
                           <span class="n">media_list</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="n">Medium</span><span class="p">],</span> 
                           <span class="n">namespace</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;BiGG&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;BiGG&#39;</span><span class="p">,</span> 
                           <span class="n">growth_threshold</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">iterations</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cobra</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform :py:func:`~specimen.core.refinement.cleanup.single_cobra_gapfill` on a list of media.</span>

<span class="sd">    Args:</span>
<span class="sd">        - model (cobra.Model): </span>
<span class="sd">            The model to be gapfilled.</span>
<span class="sd">        - universal (cobra.Model): </span>
<span class="sd">            The model to use reactions for gapfilling from.</span>
<span class="sd">        - media_list (list[Medium]): </span>
<span class="sd">            List ofmedia the model is supposed to grow on.</span>
<span class="sd">        - growth_threshold (float, optional): </span>
<span class="sd">            Growth threshold for the gapfilling. </span>
<span class="sd">            Defaults to 0.05.</span>
<span class="sd">        - iterations (int, optional): </span>
<span class="sd">            Number of iterations for the heuristic version of the gapfilling.</span>
<span class="sd">            If 0 or None is given, uses full set of reactions.</span>
<span class="sd">            Defaults to 3. </span>
<span class="sd">        - chunk_size (int, optional): </span>
<span class="sd">            Number of reactions to be used for gapfilling at the same time. </span>
<span class="sd">            If None or 0 is given, use full set, not heuristic.</span>
<span class="sd">            Defaults to 10000.</span>
<span class="sd">    Returns:</span>
<span class="sd">        cobra.Model: </span>
<span class="sd">            The gapfilled model, if a solution was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    

    <span class="k">for</span> <span class="n">medium</span> <span class="ow">in</span> <span class="n">media_list</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">cobra_gapfill_wrapper</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">universal</span><span class="p">,</span><span class="n">medium</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">growth_threshold</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span></div>



<span class="c1"># run</span>
<span class="c1"># ---</span>
<span class="c1"># @TODO add gapfilling from refinegems and more</span>
<span class="c1"># @TODO maybe a new / different way to save/store/add the params for gapfilling, e.g. a config?</span>
<div class="viewcode-block" id="run">
<a class="viewcode-back" href="../../../../../modules/core.html#specimen.hqtb.core.refinement.cleanup.run">[docs]</a>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">model</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> 
        <span class="n">biocyc_db</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">check_dupl_reac</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">check_dupl_meta</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="n">remove_unused_meta</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
        <span class="n">remove_dupl_reac</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
        <span class="n">remove_dupl_meta</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">universal</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">media_path</span><span class="p">:</span><span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">namespace</span><span class="p">:</span><span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;BiGG&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;BiGG&#39;</span><span class="p">,</span> 
        <span class="n">growth_threshold</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
        <span class="n">memote</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform the second refinement step, cleanup, on a model.</span>

<span class="sd">    The second refinement step resolves the following issues:</span>

<span class="sd">    (1) (optional) checking direction of reactions with BioCyc</span>
<span class="sd">    (2) resolve BioCyc/MetaCyc annotation inconsistencies</span>
<span class="sd">    (3) find and/or resolve duplicates (reactions and metabolites)</span>
<span class="sd">    (4) gapfilling using cobra + universal model with reactions + a set of media (@TODO: under developement)</span>

<span class="sd">    Args:</span>
<span class="sd">        - model (str): </span>
<span class="sd">            The Path to an sbml model.</span>
<span class="sd">        - dir (str): </span>
<span class="sd">            Path to the directory of the output.</span>
<span class="sd">        - biocyc_db (str, optional): </span>
<span class="sd">            Path to the BioCyc/MetaCyc reaction database file. </span>
<span class="sd">            Defaults to None, which leads to skipping the direction check.</span>
<span class="sd">        - check_dupl_reac (bool, optional): </span>
<span class="sd">            Option to check for duplicate reactions. </span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        - check_dupl_meta (bool, optional): </span>
<span class="sd">            Option to check for duplicate metabolites. </span>
<span class="sd">            Defaults to &#39;default&#39;, which checks based on MetaNetX first.</span>
<span class="sd">            Further options include &#39;skip&#39; and &#39;exhaustive&#39; (check for all possibilities).</span>
<span class="sd">        - remove_unused_meta (bool, optional): </span>
<span class="sd">            Option to remove unused metabolites from the model. </span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        - remove_dupl_reac (bool, optional): </span>
<span class="sd">            Option to remove the duplicate reactions. </span>
<span class="sd">            True is only applied, if check_dupl_reac is also True.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        - remove_dupl_meta (bool, optional): </span>
<span class="sd">            Option to remove the duplicate metabolites. </span>
<span class="sd">            True is only applied, if check_dupl_meta is also True.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        - universal (str, optional): </span>
<span class="sd">            Path to a universal model for gapfilling. </span>
<span class="sd">            Defaults to None, which skips the gapfilling.</span>
<span class="sd">        - media_path (str, optional): </span>
<span class="sd">            Path to a medium config file for gapfilling. </span>
<span class="sd">            Defaults to None.</span>
<span class="sd">        - namespace (Literal[&#39;BiGG&#39;], optional): </span>
<span class="sd">            Namespace to use for the model. </span>
<span class="sd">            Options include &#39;BiGG&#39;.</span>
<span class="sd">            Defaults to &#39;BiGG&#39;.</span>
<span class="sd">        - growth_threshold (float, optional): </span>
<span class="sd">            Growth threshold for the gapfilling. </span>
<span class="sd">            Defaults to 0.05.</span>
<span class="sd">        - iterations (int, optional): </span>
<span class="sd">            Number of iterations for the heuristic version of the gapfilling.</span>
<span class="sd">            If 0 or None is given, uses full set of reactions.</span>
<span class="sd">            Defaults to 3. </span>
<span class="sd">        - chunk_size (int, optional): </span>
<span class="sd">            Number of reactions to be used for gapfilling at the same time. </span>
<span class="sd">            If None or 0 is given, use full set, not heuristic.</span>
<span class="sd">            Defaults to 10000.</span>
<span class="sd">        - memote (bool, optional): </span>
<span class="sd">            Option to run memote on the cleaned model. </span>
<span class="sd">            Defaults to False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        - ValueError: Unknown option for check_dupl_meta</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># checking parameters</span>
    <span class="c1"># -------------------</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_dupl_meta</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span><span class="s1">&#39;skip&#39;</span><span class="p">,</span><span class="s1">&#39;exhaustive&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown option </span><span class="si">{check_dupl_meta}</span><span class="s1"> for checking duplicate metabolite. Use one of: default, skip, exhaustive&#39;</span><span class="p">)</span>

    <span class="c1"># -------------</span>
    <span class="c1"># start program</span>
    <span class="c1"># -------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">refinement step 2: clean-up</span><span class="se">\n</span><span class="s1">################################################################################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># -----------------------</span>
    <span class="c1"># create output directory</span>
    <span class="c1"># -----------------------</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;step2-clean-up&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;Creating new directory </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s2">&quot;step2-clean-up&quot;</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given directory already has required structure.&#39;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">cobra</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_sbml_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># check direction</span>
    <span class="c1"># --------------------</span>

    <span class="k">if</span> <span class="n">biocyc_db</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># --------------------</span><span class="se">\n</span><span class="s1"># check direction</span><span class="se">\n</span><span class="s1"># --------------------&#39;</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># check direction</span>
        <span class="c1"># @TODO : check namespace independency</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">check_direction</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">biocyc_db</span><span class="p">)</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>

    <span class="c1"># ----------------------------------</span>
    <span class="c1"># complete BioCyc/MetaCyc annotation</span>
    <span class="c1"># ----------------------------------</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># ----------------------------------</span><span class="se">\n</span><span class="s1"># complete BioCyc/MetaCyc annotation</span><span class="se">\n</span><span class="s1"># ----------------------------------&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">complete_BioMetaCyc</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>

    <span class="c1"># -----------------</span>
    <span class="c1"># resove duplicates</span>
    <span class="c1"># -----------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># -----------------</span><span class="se">\n</span><span class="s1"># resolve duplicates</span><span class="se">\n</span><span class="s1"># -----------------&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">resolve_duplicates</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                               <span class="n">check_reac</span> <span class="o">=</span> <span class="n">check_dupl_reac</span><span class="p">,</span>
                               <span class="n">check_meta</span> <span class="o">=</span> <span class="n">check_dupl_meta</span><span class="p">,</span>
                               <span class="n">remove_unused_meta</span> <span class="o">=</span> <span class="n">remove_unused_meta</span><span class="p">,</span>
                               <span class="n">remove_dupl_reac</span> <span class="o">=</span> <span class="n">remove_dupl_reac</span><span class="p">,</span>
                               <span class="n">replace_dupl_meta</span> <span class="o">=</span> <span class="n">remove_dupl_meta</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>

    <span class="c1"># ----------</span>
    <span class="c1"># gapfilling</span>
    <span class="c1"># ----------</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># ----------</span><span class="se">\n</span><span class="s1"># gapfilling</span><span class="se">\n</span><span class="s1"># ----------&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># construct a list of media</span>
    <span class="c1"># -------------------------</span>

    <span class="n">media_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># load media from config file</span>
    <span class="k">if</span> <span class="n">media_path</span><span class="p">:</span>
        <span class="n">media_list</span> <span class="o">=</span> <span class="n">read_media_config</span><span class="p">(</span><span class="n">media_path</span><span class="p">)</span>

    <span class="c1"># perform gapfilling</span>
    <span class="c1"># -----------------</span>
        
    <span class="c1"># ..........................................</span>
    <span class="c1"># @TODO </span>
    <span class="c1">#   add an option for refinegems gapfilling</span>
    <span class="c1">#   separate option for cobra gapfilling </span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">media_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># load universal model</span>
        <span class="n">universal_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">universal</span><span class="p">,</span><span class="s1">&#39;cobra&#39;</span><span class="p">)</span>
        <span class="c1"># run gapfilling</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">multiple_cobra_gapfill</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">universal_model</span><span class="p">,</span><span class="n">media_list</span><span class="p">,</span><span class="n">namespace</span><span class="p">,</span><span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">growth_threshold</span><span class="o">=</span><span class="n">growth_threshold</span><span class="p">)</span>
    <span class="c1"># ..........................................</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">F</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">time: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>

    <span class="c1"># ---------------------</span>
    <span class="c1"># dead ends and orphans</span>
    <span class="c1"># ---------------------</span>
    <span class="c1"># @TODO</span>
    <span class="c1"># currently no removal of dead ends and orphans as they may be interesting</span>
    <span class="c1"># for manual curation</span>

    <span class="c1"># ----------</span>
    <span class="c1"># save model</span>
    <span class="c1"># ----------</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">F</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_clean&#39;</span>
    <span class="n">cobra</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_sbml_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s1">&#39;step2-clean-up&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.xml&#39;</span><span class="p">))</span>

    <span class="c1"># ---------------------------------</span>
    <span class="c1"># assess model quality using memote</span>
    <span class="c1"># ---------------------------------</span>
        
    <span class="k">if</span> <span class="n">memote</span><span class="p">:</span>
        <span class="n">memote_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="s1">&#39;step2-clean-up&#39;</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.html&#39;</span><span class="p">)</span>
        <span class="n">run_memote</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">return_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_res</span><span class="o">=</span><span class="n">memote_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Carolin Brune.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>